# 虎皮椒支付集成说明

## 📋 集成完成状态

✅ **已完成**: 虎皮椒支付网关 `XunhuPay.php` 已成功创建并集成到Xboard系统中

## 🎯 功能特性

### 支持的支付方式
- ✅ **微信支付** (H5支付)
- ✅ **支付宝支付**
- ✅ **自动签名验证**
- ✅ **安全回调处理**

### 核心功能
- ✅ **统一接口**: 实现PaymentInterface接口，完全兼容现有系统
- ✅ **配置管理**: 友好的管理后台配置界面
- ✅ **错误处理**: 完善的异常处理和日志记录
- ✅ **安全验证**: MD5签名验证，防止数据篡改

## 🚀 使用步骤

### 1. 虎皮椒平台准备
1. 注册虎皮椒账号：
   - 正式平台：https://admin.xunhupay.com (已满员)
   - 备用平台：https://admin.dpweixin.com (推荐)
2. 获取必要信息：
   - `APPID`: 虎皮椒分配的应用ID
   - `APPSECRET`: 虎皮椒分配的密钥
   - 完成微信/支付宝签约

### 2. Xboard后台配置
1. 登录Xboard管理后台
2. 进入 **系统设置** → **支付设置**
3. 点击 **添加支付方式**
4. 选择支付网关：**XunhuPay**
5. 填写配置信息：

```yaml
显示名称: 虎皮椒支付 (或自定义名称)
API接口地址: https://api.xunhupay.com/payment/do.html
APPID: [您的虎皮椒APPID]
APPSECRET: [您的虎皮椒密钥]
支付类型: 
  - wechat (微信支付)
  - alipay (支付宝支付)
网站名称: [您的网站名称，32字符以内]
网站域名: [您的网站域名，如: https://example.com]
```

### 3. 高级配置 (可选)
- **自定义通知域名**: 如果需要使用特定域名接收回调
- **手续费设置**: 固定手续费 + 百分比手续费
- **图标设置**: 上传支付方式图标

## 🔧 技术实现详情

### 文件位置
```
app/Payments/XunhuPay.php  # 虎皮椒支付网关实现
```

### 核心方法
```php
// 配置表单
public function form(): array

// 发起支付  
public function pay($order): array

// 处理回调
public function notify($params): array|bool
```

### 支付流程
1. **用户发起支付** → 调用 `pay()` 方法
2. **构建请求参数** → 包含订单信息、金额、回调地址等
3. **生成MD5签名** → 按ASCII排序 + APPSECRET
4. **请求虎皮椒API** → POST到支付接口
5. **返回支付URL** → 用户跳转完成支付
6. **接收支付回调** → 验证签名，更新订单状态

### 回调处理
- **回调地址**: `/api/v1/guest/payment/notify/XunhuPay/{uuid}`
- **验证签名**: 确保回调来源可信
- **检查状态**: 只处理 `OD`(已支付) 状态
- **返回结果**: 必须返回 `success` 给虎皮椒

## 🛡️ 安全特性

### 签名验证
- **发起支付**: 所有参数按ASCII排序 + APPSECRET + MD5
- **回调验证**: 验证虎皮椒回调签名的真实性
- **防重放**: 使用随机字符串防止重放攻击

### 错误处理
- **网络异常**: 超时、连接失败等
- **API错误**: 虎皮椒返回的错误信息
- **签名失败**: 签名验证不通过
- **状态异常**: 非正常支付状态

### 日志记录
- **成功支付**: 记录订单号、金额、支付类型
- **失败支付**: 记录错误原因和堆栈信息
- **回调处理**: 记录回调参数和处理结果

## 🔍 测试建议

### 1. 配置测试
- 在管理后台添加虎皮椒支付方式
- 验证配置表单是否正确显示
- 检查必填字段验证

### 2. 支付流程测试
- 创建测试订单
- 选择虎皮椒支付
- 验证跳转到正确的支付页面
- 完成支付并检查订单状态

### 3. 回调测试
- 使用虎皮椒提供的测试工具
- 验证回调签名验证
- 检查订单状态更新

## 🚨 注意事项

### 1. 环境要求
- ✅ **HTTPS**: 虎皮椒要求使用HTTPS协议
- ✅ **域名**: 需要正确配置网站域名
- ✅ **网络**: 确保服务器能访问虎皮椒API

### 2. 配置要点
- **APPSECRET**: 严格保密，不要泄露
- **回调域名**: 必须是可公网访问的HTTPS地址
- **网站名称**: 不能包含特殊字符或表情符号

### 3. 常见问题
- **签名错误**: 检查APPSECRET是否正确
- **回调失败**: 确认回调地址可访问
- **支付失败**: 查看日志文件排查原因

## 📞 技术支持

### 虎皮椒官方
- **QQ群**: 295292794
- **微信客服**: hupijiao007
- **官方文档**: https://www.xunhupay.com/doc/api/pay.html

### 集成支持
- 查看Laravel日志: `storage/logs/laravel.log`
- 检查支付配置: 管理后台 → 支付设置
- 验证网络连通: 测试到虎皮椒API的连接

## ✅ 集成验证清单

- [ ] 虎皮椒账号注册并获取APPID/APPSECRET
- [ ] Xboard后台成功添加虎皮椒支付方式
- [ ] 配置信息填写完整且正确
- [ ] 网站使用HTTPS协议
- [ ] 回调地址可公网访问
- [ ] 测试支付流程完整
- [ ] 订单状态正确更新
- [ ] 日志记录正常

---

🎉 **恭喜！虎皮椒支付已成功集成到您的Xboard系统中！**
